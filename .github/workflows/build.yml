name: Build-Veloera
on: 
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (leave empty for latest)'
        required: false
        default: ''
  schedule:
    - cron: '0 2 * * 0'  # 每周日凌晨2点自动构建
  push:
    branches: [ main ]  # 当推送到主分支时触发

permissions:
  contents: write
  actions: write
  packages: write

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Get latest tag
        id: get_tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            # 添加错误处理
            tag=$(curl -s "https://api.github.com/repos/Veloera/Veloera/tags" | jq -r '.[0].name // "v1.0.0"')
            echo "tag=$tag" >> $GITHUB_OUTPUT
          fi
          echo "Selected tag: $tag"

  build-all:
    runs-on: ubuntu-latest
    needs: get-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Clone Veloera repo
        run: |
          git clone -b ${{ needs.get-version.outputs.tag }} https://github.com/Veloera/Veloera.git veloera-src
          
      - name: Cache Bun dependencies
        uses: actions/cache@v3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('veloera-src/web/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('veloera-src/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build Frontend
        env:
          CI: false
          DISABLE_ESLINT_PLUGIN: true
        run: |
          cd veloera-src/web
          
          # 检查是否存在 package.json
          if [ ! -f package.json ]; then
            echo "package.json not found!"
            exit 1
          fi
          
          # 安装依赖
          bun install
          
          # 创建或更新 vite.config.js
          cat > vite.config.js << 'EOF'
          import { defineConfig } from "vite";
          import react from "@vitejs/plugin-react";
          
          export default defineConfig({
            esbuild: {
              loader: "jsx",
              include: /src\/.*\.[jt]sx?$/,
              exclude: []
            },
            optimizeDeps: {
              esbuildOptions: {
                loader: {
                  ".js": "jsx"
                }
              }
            },
            build: {
              outDir: "dist",
              rollupOptions: {
                external: ["sse"]
              }
            },
            plugins: [react()]
          });
          EOF
          
          # 构建前端
          VITE_REACT_APP_VERSION=${{ needs.get-version.outputs.tag }} bun run build
          
      - name: Verify frontend build
        run: |
          echo "Checking frontend build files:"
          ls -la veloera-src/web/dist/ || echo "No dist directory found"
          find veloera-src/web/dist/ -type f | head -10 || echo "No files found"

      - name: Build Backend
        run: |
          cd veloera-src
          go mod download
          
          # 构建 Linux 版本
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags "-s -w -X 'one-api/common.Version=${{ needs.get-version.outputs.tag }}'" \
            -o veloera-linux-amd64
          
          # 构建 FreeBSD 版本
          CGO_ENABLED=0 GOOS=freebsd GOARCH=amd64 go build \
            -ldflags "-s -w -X 'one-api/common.Version=${{ needs.get-version.outputs.tag }}'" \
            -o veloera-freebsd-amd64

      - name: Upload builds
        uses: actions/upload-artifact@v4
        with:
          name: veloera-builds
          path: |
            veloera-src/veloera-linux-amd64
            veloera-src/veloera-freebsd-amd64
            veloera-src/web/dist/

  create-release:
    runs-on: ubuntu-latest
    needs: [get-version, build-all]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.get-version.outputs.tag }}-build
          name: Veloera Build ${{ needs.get-version.outputs.tag }}
          body: |
            Automated build of Veloera ${{ needs.get-version.outputs.tag }}
            
            ## Files included:
            - `veloera-linux-amd64`: Linux AMD64 binary
            - `veloera-freebsd-amd64`: FreeBSD AMD64 binary  
            - Frontend build artifacts
            
            Built on: ${{ github.run_number }}
          files: |
            artifacts/veloera-builds/*
          draft: false
          prerelease: false

  cleanup:
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 5
